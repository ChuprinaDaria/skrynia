name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy backend'
        required: false
        default: 'true'
      deploy_frontend:
        description: 'Deploy frontend'
        required: false
        default: 'true'

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE_NAME: chuprinadaria/skrynia/backend
  FRONTEND_IMAGE_NAME: chuprinadaria/skrynia/frontend

jobs:
  build-backend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (backend)
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}
          tags: |
            type=sha,format=short,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./skrynia/backend
          file: ./skrynia/backend/Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            FACEBOOK_PIXEL_ID=${{ secrets.FACEBOOK_PIXEL_ID }}
            FACEBOOK_ACCESS_TOKEN=${{ secrets.FACEBOOK_ACCESS_TOKEN }}
            FACEBOOK_DATASET_QUALITY_TOKEN=${{ secrets.FACEBOOK_DATASET_QUALITY_TOKEN }}
            FACEBOOK_API_VERSION=${{ secrets.FACEBOOK_API_VERSION || 'v18.0' }}

  build-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (frontend)
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}
          tags: |
            type=sha,format=short,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push frontend image
        uses: docker/build-push-action@v6
        with:
          context: ./skrynia
          file: ./skrynia/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL || 'https://runebox.eu' }}
            NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://runebox.eu' }}
            NEXT_PUBLIC_INPOST_GEOWIDGET_TOKEN=${{ secrets.INPOST_GEOWIDGET_TOKEN }}
            NEXT_PUBLIC_INPOST_SANDBOX=${{ secrets.INPOST_SANDBOX || 'true' }}

  deploy:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 5.78.152.139 >> ~/.ssh/known_hosts || true

      - name: Deploy to VPS
        timeout-minutes: 10
        run: |
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@5.78.152.139 bash << 'ENDSSH'
            set -e
            mkdir -p /app/runebox
            cd /app/runebox
            
            echo "ðŸ“¦ Updating repository..."
            if [ ! -d ".git" ]; then
              git clone https://github.com/ChuprinaDaria/skrynia.git .
            else
              git fetch origin
              git reset --hard origin/main
            fi
            
            echo "ðŸ“ Creating/updating .env file..."
            # Force overwrite .env file with latest secrets from GitHub Secrets
            cat > .env << 'ENVEOF'
          # Database
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@db:5432/${{ secrets.POSTGRES_DB }}
          
          # Application
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          BACKEND_URL=${{ secrets.BACKEND_URL }}
          DEBUG=False
          
          # Frontend Environment Variables
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_SITE_URL=${{ secrets.NEXT_PUBLIC_SITE_URL }}
          NEXT_PUBLIC_INPOST_GEOWIDGET_TOKEN=${{ secrets.INPOST_GEOWIDGET_TOKEN }}
          NEXT_PUBLIC_INPOST_SANDBOX=${{ secrets.INPOST_SANDBOX }}
          
          # Stripe Payment
          STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_PUBLIC_KEY=${{ secrets.STRIPE_PUBLIC_KEY }}
          STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
          
          # Przelewy24 Payment
          P24_MERCHANT_ID=${{ secrets.P24_MERCHANT_ID }}
          P24_POS_ID=${{ secrets.P24_POS_ID }}
          P24_CRC=${{ secrets.P24_CRC }}
          P24_API_KEY=${{ secrets.P24_API_KEY }}
          
          # Email Configuration
          MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_FROM=${{ secrets.MAIL_FROM }}
          MAIL_SERVER=${{ secrets.MAIL_SERVER }}
          MAIL_FROM_NAME=${{ secrets.MAIL_FROM_NAME }}
          
          # InPost Shipping
          INPOST_API_TOKEN=${{ secrets.INPOST_API_TOKEN }}
          INPOST_ORGANIZATION_ID=${{ secrets.INPOST_ORGANIZATION_ID }}
          INPOST_GEOWIDGET_TOKEN=${{ secrets.INPOST_GEOWIDGET_TOKEN }}
          INPOST_SANDBOX=${{ secrets.INPOST_SANDBOX }}
          
          # Docker Images (from GitHub Container Registry)
          BACKEND_IMAGE=${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE_NAME }}:latest
          FRONTEND_IMAGE=${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE_NAME }}:latest
          ENVEOF
            
            echo "âœ… .env file updated with latest secrets"
            
            echo "ðŸ” Logging in to GHCR..."
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u chuprinadaria --password-stdin
            
            echo "ðŸ³ Pulling latest Docker images..."
            docker compose -f docker-compose.prod.yml pull || {
              echo "âš ï¸  Warning: Failed to pull some images, continuing..."
            }
            
            echo "ðŸ”„ Stopping containers to apply new environment..."
            # Stop containers before restarting (preserves volumes/database)
            docker compose -f docker-compose.prod.yml down --remove-orphans || true
            
            echo "ðŸš€ Starting containers with updated .env file..."
            # Start all containers - backend will read .env file, frontend uses runtime env from docker-compose.prod.yml
            docker compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans || {
              echo "âŒ Failed to start containers"
              exit 1
            }
            
            echo "â³ Waiting for services to be ready..."
            sleep 15
            
            echo "ðŸ—„ï¸  Running database migrations..."
            docker compose -f docker-compose.prod.yml exec -T backend alembic upgrade head || {
              echo "âš ï¸  Warning: Migration failed, but continuing..."
            }
            
            echo "âœ… Deployment successful!"
            echo "ðŸ“Š Container status:"
            docker compose -f docker-compose.prod.yml ps
          ENDSSH

  bulk-import-products:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3 jq

      - name: Wait for API to be ready
        run: |
          echo "â³ ÐžÑ‡Ñ–ÐºÑƒÐ²Ð°Ð½Ð½Ñ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ñ– API..."
          for i in {1..30}; do
            if curl -f -s "${{ secrets.BACKEND_URL || secrets.NEXT_PUBLIC_API_URL }}/api/v1/products" > /dev/null; then
              echo "âœ… API Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ð¹!"
              break
            fi
            echo "  Ð¡Ð¿Ñ€Ð¾Ð± $i/30..."
            sleep 2
          done

      - name: Get Admin Token
        id: get_token
        env:
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          API_URL: ${{ secrets.BACKEND_URL || secrets.NEXT_PUBLIC_API_URL }}
        run: |
          echo "ðŸ” ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ admin token..."
          echo "API URL: $API_URL"
          
          # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ñ– API
          echo "ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ñ– API..."
          if curl -f -s --max-time 10 "$API_URL/api/v1/products" > /dev/null 2>&1; then
            echo "âœ… API Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹"
          else
            echo "âš ï¸  API Ð½Ðµ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ”, Ð°Ð»Ðµ Ð¿Ñ€Ð¾Ð´Ð¾Ð²Ð¶ÑƒÑ”Ð¼Ð¾ ÑÐ¿Ñ€Ð¾Ð±Ñƒ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ token..."
          fi
          
          # ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ token Ð· Ð¾Ð±Ñ€Ð¾Ð±ÐºÐ¾ÑŽ Ð¿Ð¾Ð¼Ð¸Ð»Ð¾Ðº
          set +e  # ÐÐµ Ð·ÑƒÐ¿Ð¸Ð½ÑÑ‚Ð¸ÑÑ Ð½Ð° Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°Ñ… curl
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "$API_URL/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$ADMIN_EMAIL\",\"password\":\"$ADMIN_PASSWORD\"}" \
            --max-time 30 \
            --connect-timeout 10 \
            --retry 2 \
            --retry-delay 3 \
            2>&1)
          CURL_EXIT=$?
          set -e
          
          if [ $CURL_EXIT -ne 0 ]; then
            echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° curl Ð·Ð°Ð¿Ð¸Ñ‚Ñƒ (exit code: $CURL_EXIT)"
            echo "Response: $RESPONSE"
            echo ""
            echo "ÐœÐ¾Ð¶Ð»Ð¸Ð²Ñ– Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð¸:"
            echo "  - API Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹ ($API_URL)"
            echo "  - ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð¸ Ð· SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ñ–ÐºÐ°Ñ‚Ð¾Ð¼ (exit code 60)"
            echo "  - Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð·'Ñ”Ð´Ð½Ð°Ð½Ð½Ñ"
            echo "  - ÐœÐµÑ€ÐµÐ¶ÐµÐ²Ð° Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°"
            echo "âš ï¸  Bulk import Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ð¾Ð¼Ð¸Ð»ÐºÑƒ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ token"
            exit 0  # ÐÐµ Ð±Ð»Ð¾ÐºÑƒÑ”Ð¼Ð¾ deployment
          fi
          
          # Ð’Ð¸Ñ‚ÑÐ³ÑƒÑ”Ð¼Ð¾ HTTP ÐºÐ¾Ð´
          HTTP_CODE=$(echo "$RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2 || echo "000")
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° API: HTTP $HTTP_CODE"
            echo "Response body: $BODY"
            if [ "$HTTP_CODE" == "401" ]; then
              echo "  ÐœÐ¾Ð¶Ð»Ð¸Ð²Ð° Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð°: Ð½ÐµÐ²Ñ–Ñ€Ð½Ð¸Ð¹ email Ð°Ð±Ð¾ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ"
            elif [ "$HTTP_CODE" == "000" ]; then
              echo "  ÐœÐ¾Ð¶Ð»Ð¸Ð²Ð° Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð°: API Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹ Ð°Ð±Ð¾ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚"
            fi
            echo "âš ï¸  Bulk import Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ð¾Ð¼Ð¸Ð»ÐºÑƒ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ token"
            exit 0  # ÐÐµ Ð±Ð»Ð¾ÐºÑƒÑ”Ð¼Ð¾ deployment
          fi
          
          # Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ Python Ð´Ð»Ñ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ñƒ JSON
          TOKEN=$(echo "$BODY" | python3 -c "
          import sys, json
          try:
              data = json.load(sys.stdin)
              token = data.get('access_token', '')
              if not token:
                  print('Token not found in response', file=sys.stderr)
              print(token)
          except json.JSONDecodeError as e:
              print(f'JSON decode error: {e}', file=sys.stderr)
              sys.exit(1)
          except Exception as e:
              print(f'Error: {e}', file=sys.stderr)
              sys.exit(1)
          " 2>&1)
          PYTHON_EXIT=$?
          
          if [ $PYTHON_EXIT -ne 0 ] || [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then
            echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ token"
            echo "Python exit code: $PYTHON_EXIT"
            echo "Python output: $TOKEN"
            echo "Response body: $BODY"
            echo "âš ï¸  Bulk import Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ð¾Ð¼Ð¸Ð»ÐºÑƒ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ token"
            exit 0  # ÐÐµ Ð±Ð»Ð¾ÐºÑƒÑ”Ð¼Ð¾ deployment
          fi
          
          echo "âœ… Token Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾"
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Check products folder exists
        run: |
          if [ ! -d "Ñ‚Ð¾Ð²Ð°Ñ€Ð¸" ]; then
            echo "âš ï¸  ÐŸÐ°Ð¿ÐºÐ° 'Ñ‚Ð¾Ð²Ð°Ñ€Ð¸' Ð½Ðµ Ñ–ÑÐ½ÑƒÑ”, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°Ñ”Ð¼Ð¾ bulk import"
            exit 0
          fi
          
          PRODUCT_COUNT=$(find Ñ‚Ð¾Ð²Ð°Ñ€Ð¸ -name "product.json" -type f | wc -l)
          echo "ðŸ“¦ Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ $PRODUCT_COUNT Ñ‚Ð¾Ð²Ð°Ñ€Ñ–Ð² Ð´Ð»Ñ Ñ–Ð¼Ð¿Ð¾Ñ€Ñ‚Ñƒ"
          
          if [ "$PRODUCT_COUNT" -eq 0 ]; then
            echo "âš ï¸  ÐÐµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ñ–Ð² Ð´Ð»Ñ Ñ–Ð¼Ð¿Ð¾Ñ€Ñ‚Ñƒ"
            exit 0
          fi

      - name: Run bulk import script
        if: steps.get_token.outputs.token != ''
        env:
          ADMIN_TOKEN: ${{ steps.get_token.outputs.token }}
          API_BASE_URL: ${{ secrets.BACKEND_URL || secrets.NEXT_PUBLIC_API_URL }}
        run: |
          echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº bulk import..."
          python scripts/bulk_import_products.py \
            --path "Ñ‚Ð¾Ð²Ð°Ñ€Ð¸" \
            --api-url "$API_BASE_URL" \
            --token "$ADMIN_TOKEN" || {
            echo "âš ï¸  Bulk import Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð²ÑÑ Ð· Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°Ð¼Ð¸, Ð°Ð»Ðµ deployment ÑƒÑÐ¿Ñ–ÑˆÐ½Ð¸Ð¹"
            exit 0  # ÐÐµ Ð±Ð»Ð¾ÐºÑƒÑ”Ð¼Ð¾ deployment
          }

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Bulk Import Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: \`${{ secrets.BACKEND_URL || secrets.NEXT_PUBLIC_API_URL }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Bulk import Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!" >> $GITHUB_STEP_SUMMARY

