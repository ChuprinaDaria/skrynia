name: Bulk Import Products

on:
  workflow_dispatch:
    inputs:
      products_path:
        description: 'Path to products folder'
        required: false
        default: '—Ç–æ–≤–∞—Ä–∏'
      api_url:
        description: 'API Base URL'
        required: false
        default: 'https://api.runebox.eu'
      skip_errors:
        description: 'Skip errors and continue'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
    paths:
      - '—Ç–æ–≤–∞—Ä–∏/**'
      - 'scripts/bulk_import_products.py'
  schedule:
    # –ó–∞–ø—É—Å–∫–∞—Ç–∏ —â–æ–¥–Ω—è –æ 3:00 UTC (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
    - cron: '0 3 * * *'

env:
  API_BASE_URL: ${{ inputs.api_url || 'https://api.runebox.eu' }}
  PRODUCTS_PATH: ${{ inputs.products_path || '—Ç–æ–≤–∞—Ä–∏' }}

jobs:
  bulk-import:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3
          # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
          python3 -c "import requests; print(f'requests version: {requests.__version__}')"

      - name: Get Admin Token
        id: get_token
        env:
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          API_URL: ${{ env.API_BASE_URL }}
        run: |
          echo "üîê –û—Ç—Ä–∏–º–∞–Ω–Ω—è admin token..."
          echo "API URL: $API_URL"
          
          # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Python requests –∑–∞–º—ñ—Å—Ç—å curl (–∫—Ä–∞—â–µ –æ–±—Ä–æ–±–ª—è—î SSL)
          python3 << 'EOF'
          import os
          import sys
          import requests
          import json
          from urllib3.exceptions import InsecureRequestWarning
          
          # –í–∏–º–∫–Ω—É—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ –Ω–µ–±–µ–∑–ø–µ—á–Ω—ñ –∑–∞–ø–∏—Ç–∏ (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
          # requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
          
          api_url = os.environ.get('API_URL', 'https://api.runebox.eu')
          admin_email = os.environ.get('ADMIN_EMAIL')
          admin_password = os.environ.get('ADMIN_PASSWORD')
          
          if not admin_email or not admin_password:
              print("‚ùå –ü–æ–º–∏–ª–∫–∞: ADMIN_EMAIL –∞–±–æ ADMIN_PASSWORD –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –≤ Secrets")
              sys.exit(1)
          
          # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ API
          print("–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ API...")
          try:
              response = requests.get(f"{api_url}/api/v1/products", timeout=10, verify=True)
              if response.status_code == 200:
                  print("‚úÖ API –¥–æ—Å—Ç—É–ø–Ω–∏–π")
              else:
                  print(f"‚ö†Ô∏è  API –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑ –∫–æ–¥–æ–º {response.status_code}, –∞–ª–µ –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ...")
          except requests.exceptions.RequestException as e:
              print(f"‚ö†Ô∏è  API –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î: {e}")
              print("–ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ —Å–ø—Ä–æ–±—É –æ—Ç—Ä–∏–º–∞—Ç–∏ token...")
          
          # –û—Ç—Ä–∏–º–∞–Ω–Ω—è token
          login_url = f"{api_url}/api/v1/auth/login"
          payload = {
              "email": admin_email,
              "password": admin_password
          }
          
          try:
              print(f"–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–ø–∏—Ç—É –Ω–∞ {login_url}...")
              response = requests.post(
                  login_url,
                  json=payload,
                  headers={"Content-Type": "application/json"},
                  timeout=30,
                  verify=True  # –ü–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ SSL —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç
              )
              
              print(f"HTTP Code: {response.status_code}")
              
              if response.status_code != 200:
                  print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ API: HTTP {response.status_code}")
                  print(f"Response: {response.text}")
                  if response.status_code == 401:
                      print("  –ú–æ–∂–ª–∏–≤–∞ –ø—Ä–∏—á–∏–Ω–∞: –Ω–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å")
                  elif response.status_code == 404:
                      print("  –ú–æ–∂–ª–∏–≤–∞ –ø—Ä–∏—á–∏–Ω–∞: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π URL API")
                  sys.exit(1)
              
              try:
                  data = response.json()
                  token = data.get('access_token', '')
                  
                  if not token:
                      print("‚ùå –ü–æ–º–∏–ª–∫–∞: Token –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –≤ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ")
                      print(f"Response: {response.text}")
                      sys.exit(1)
                  
                  print("‚úÖ Token –æ—Ç—Ä–∏–º–∞–Ω–æ")
                  # –í–∏–≤–æ–¥–∏–º–æ token –¥–ª—è GitHub Actions output
                  print(f"::add-mask::{token}")
                  print(f"token={token}", file=open(os.environ.get('GITHUB_OUTPUT', '/dev/stdout'), 'a'))
                  
              except json.JSONDecodeError as e:
                  print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É JSON: {e}")
                  print(f"Response: {response.text}")
                  sys.exit(1)
                  
          except requests.exceptions.SSLError as e:
              print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ SSL: {e}")
              print("–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:")
              print("  - –ù–µ–≤–∞–ª—ñ–¥–Ω–∏–π SSL —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç")
              print("  - –ü—Ä–æ–±–ª–µ–º–∏ –∑ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–∞")
              print("  - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –¥–æ–º–µ–Ω")
              sys.exit(1)
          except requests.exceptions.Timeout:
              print("‚ùå –ü–æ–º–∏–ª–∫–∞: –¢–∞–π–º–∞—É—Ç –∑'—î–¥–Ω–∞–Ω–Ω—è")
              sys.exit(1)
          except requests.exceptions.ConnectionError as e:
              print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è: {e}")
              print("–ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:")
              print(f"  - API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π ({api_url})")
              print("  - –ü—Ä–æ–±–ª–µ–º–∏ –∑ –º–µ—Ä–µ–∂–µ—é")
              sys.exit(1)
          except Exception as e:
              print(f"‚ùå –ù–µ–æ—á—ñ–∫—É–≤–∞–Ω–∞ –ø–æ–º–∏–ª–∫–∞: {e}")
              sys.exit(1)
          EOF

      - name: Check products folder exists
        run: |
          if [ ! -d "${{ env.PRODUCTS_PATH }}" ]; then
            echo "‚ùå –ü–∞–ø–∫–∞ '${{ env.PRODUCTS_PATH }}' –Ω–µ —ñ—Å–Ω—É—î"
            exit 1
          fi
          
          PRODUCT_COUNT=$(find "${{ env.PRODUCTS_PATH }}" -name "product.json" -type f | wc -l)
          echo "üì¶ –ó–Ω–∞–π–¥–µ–Ω–æ $PRODUCT_COUNT —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É"
          
          if [ "$PRODUCT_COUNT" -eq 0 ]; then
            echo "‚ö†Ô∏è  –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä—ñ–≤ –¥–ª—è —ñ–º–ø–æ—Ä—Ç—É"
            exit 0
          fi

      - name: Run bulk import script
        env:
          ADMIN_TOKEN: ${{ steps.get_token.outputs.token }}
          API_BASE_URL: ${{ env.API_BASE_URL }}
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫ bulk import..."
          python scripts/bulk_import_products.py \
            --path "${{ env.PRODUCTS_PATH }}" \
            --api-url "${{ env.API_BASE_URL }}" \
            --token "$ADMIN_TOKEN" || {
            if [ "${{ inputs.skip_errors }}" == "true" ]; then
              echo "‚ö†Ô∏è  –ü–æ–º–∏–ª–∫–∏ —ñ–≥–Ω–æ—Ä–æ–≤–∞–Ω—ñ (skip_errors=true)"
              exit 0
            else
              echo "‚ùå Bulk import –∑–∞–≤–µ—Ä—à–∏–≤—Å—è –∑ –ø–æ–º–∏–ª–∫–∞–º–∏"
              exit 1
            fi
          }

      - name: Summary
        if: always()
        run: |
          echo "## üìä Bulk Import Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Products Path**: \`${{ env.PRODUCTS_PATH }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: \`${{ env.API_BASE_URL }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Bulk import –∑–∞–≤–µ—Ä—à–µ–Ω–æ!" >> $GITHUB_STEP_SUMMARY

