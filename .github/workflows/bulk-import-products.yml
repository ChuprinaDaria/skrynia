name: Bulk Import Products

on:
  workflow_dispatch:
    inputs:
      products_path:
        description: 'Path to products folder'
        required: false
        default: 'Ñ‚Ð¾Ð²Ð°Ñ€Ð¸'
      api_url:
        description: 'API Base URL'
        required: false
        default: 'https://api.runebox.eu'
      skip_errors:
        description: 'Skip errors and continue'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'Ñ‚Ð¾Ð²Ð°Ñ€Ð¸/**'
      - 'scripts/bulk_import_products.py'
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚Ð¸ Ñ‰Ð¾Ð´Ð½Ñ Ð¾ 3:00 UTC (Ð¾Ð¿Ñ†Ñ–Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
    - cron: '0 3 * * *'

env:
  API_BASE_URL: ${{ inputs.api_url || 'https://api.runebox.eu' }}
  PRODUCTS_PATH: ${{ inputs.products_path || 'Ñ‚Ð¾Ð²Ð°Ñ€Ð¸' }}

jobs:
  bulk-import:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3

      - name: Get Admin Token
        id: get_token
        env:
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          API_URL: ${{ env.API_BASE_URL }}
        run: |
          echo "ðŸ” ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ admin token..."
          RESPONSE=$(curl -s -X POST "$API_URL/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$ADMIN_EMAIL\",\"password\":\"$ADMIN_PASSWORD\"}")
          
          # Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ Python Ð´Ð»Ñ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ñƒ JSON (Ð±Ñ–Ð»ÑŒÑˆ Ð½Ð°Ð´Ñ–Ð¹Ð½Ð¾)
          TOKEN=$(echo $RESPONSE | python3 -c "import sys, json; print(json.load(sys.stdin).get('access_token', ''))" 2>/dev/null || echo "")
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then
            echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ token"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          echo "âœ… Token Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾"
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Check products folder exists
        run: |
          if [ ! -d "${{ env.PRODUCTS_PATH }}" ]; then
            echo "âŒ ÐŸÐ°Ð¿ÐºÐ° '${{ env.PRODUCTS_PATH }}' Ð½Ðµ Ñ–ÑÐ½ÑƒÑ”"
            exit 1
          fi
          
          PRODUCT_COUNT=$(find "${{ env.PRODUCTS_PATH }}" -name "product.json" -type f | wc -l)
          echo "ðŸ“¦ Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ $PRODUCT_COUNT Ñ‚Ð¾Ð²Ð°Ñ€Ñ–Ð² Ð´Ð»Ñ Ñ–Ð¼Ð¿Ð¾Ñ€Ñ‚Ñƒ"
          
          if [ "$PRODUCT_COUNT" -eq 0 ]; then
            echo "âš ï¸  ÐÐµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ñ–Ð² Ð´Ð»Ñ Ñ–Ð¼Ð¿Ð¾Ñ€Ñ‚Ñƒ"
            exit 0
          fi

      - name: Run bulk import script
        env:
          ADMIN_TOKEN: ${{ steps.get_token.outputs.token }}
          API_BASE_URL: ${{ env.API_BASE_URL }}
        run: |
          echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº bulk import..."
          python scripts/bulk_import_products.py \
            --path "${{ env.PRODUCTS_PATH }}" \
            --api-url "${{ env.API_BASE_URL }}" \
            --token "$ADMIN_TOKEN" || {
            if [ "${{ inputs.skip_errors }}" == "true" ]; then
              echo "âš ï¸  ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ¸ Ñ–Ð³Ð½Ð¾Ñ€Ð¾Ð²Ð°Ð½Ñ– (skip_errors=true)"
              exit 0
            else
              echo "âŒ Bulk import Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð²ÑÑ Ð· Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°Ð¼Ð¸"
              exit 1
            fi
          }

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Bulk Import Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Products Path**: \`${{ env.PRODUCTS_PATH }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: \`${{ env.API_BASE_URL }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Bulk import Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!" >> $GITHUB_STEP_SUMMARY

