name: Bulk Import Products

on:
  workflow_dispatch:
    inputs:
      products_path:
        description: 'Path to products folder'
        required: false
        default: 'Ñ‚Ð¾Ð²Ð°Ñ€Ð¸'
      api_url:
        description: 'API Base URL'
        required: false
        default: 'https://api.runebox.eu'
      skip_errors:
        description: 'Skip errors and continue'
        required: false
        default: 'false'
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'Ñ‚Ð¾Ð²Ð°Ñ€Ð¸/**'
      - 'scripts/bulk_import_products.py'
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°Ñ‚Ð¸ Ñ‰Ð¾Ð´Ð½Ñ Ð¾ 3:00 UTC (Ð¾Ð¿Ñ†Ñ–Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
    - cron: '0 3 * * *'

env:
  API_BASE_URL: ${{ inputs.api_url || 'https://api.runebox.eu' }}
  PRODUCTS_PATH: ${{ inputs.products_path || 'Ñ‚Ð¾Ð²Ð°Ñ€Ð¸' }}

jobs:
  bulk-import:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests urllib3

      - name: Get Admin Token
        id: get_token
        env:
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          API_URL: ${{ env.API_BASE_URL }}
        run: |
          echo "ðŸ” ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ admin token..."
          echo "API URL: $API_URL"
          
          # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ñ– API
          echo "ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ñ– API..."
          if ! curl -f -s --max-time 10 "$API_URL/api/v1/products" > /dev/null 2>&1; then
            echo "âš ï¸  API Ð½Ðµ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ñ”, Ð°Ð»Ðµ Ð¿Ñ€Ð¾Ð´Ð¾Ð²Ð¶ÑƒÑ”Ð¼Ð¾..."
          else
            echo "âœ… API Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹"
          fi
          
          # ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ token Ð· Ð¾Ð±Ñ€Ð¾Ð±ÐºÐ¾ÑŽ Ð¿Ð¾Ð¼Ð¸Ð»Ð¾Ðº
          set +e  # ÐÐµ Ð·ÑƒÐ¿Ð¸Ð½ÑÑ‚Ð¸ÑÑ Ð½Ð° Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°Ñ… curl
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "$API_URL/api/v1/auth/login" \
            -H "Content-Type: application/json" \
            -d "{\"email\":\"$ADMIN_EMAIL\",\"password\":\"$ADMIN_PASSWORD\"}" \
            --max-time 30 \
            --connect-timeout 10 \
            --retry 2 \
            --retry-delay 3 \
            2>&1)
          CURL_EXIT=$?
          set -e
          
          if [ $CURL_EXIT -ne 0 ]; then
            echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° curl Ð·Ð°Ð¿Ð¸Ñ‚Ñƒ (exit code: $CURL_EXIT)"
            echo "Response: $RESPONSE"
            echo ""
            echo "ÐœÐ¾Ð¶Ð»Ð¸Ð²Ñ– Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð¸:"
            echo "  - API Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹ ($API_URL)"
            echo "  - ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð¸ Ð· SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ñ–ÐºÐ°Ñ‚Ð¾Ð¼ (exit code 60)"
            echo "  - Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð·'Ñ”Ð´Ð½Ð°Ð½Ð½Ñ"
            echo "  - ÐœÐµÑ€ÐµÐ¶ÐµÐ²Ð° Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°"
            exit 1
          fi
          
          # Ð’Ð¸Ñ‚ÑÐ³ÑƒÑ”Ð¼Ð¾ HTTP ÐºÐ¾Ð´
          HTTP_CODE=$(echo "$RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE:/d')
          
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° API: HTTP $HTTP_CODE"
            echo "Response body: $BODY"
            exit 1
          fi
          
          # Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ Python Ð´Ð»Ñ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ñƒ JSON
          TOKEN=$(echo "$BODY" | python3 -c "
          import sys, json
          try:
              data = json.load(sys.stdin)
              token = data.get('access_token', '')
              if not token:
                  print('Token not found in response', file=sys.stderr)
              print(token)
          except json.JSONDecodeError as e:
              print(f'JSON decode error: {e}', file=sys.stderr)
              sys.exit(1)
          except Exception as e:
              print(f'Error: {e}', file=sys.stderr)
              sys.exit(1)
          " 2>&1)
          PYTHON_EXIT=$?
          
          if [ $PYTHON_EXIT -ne 0 ] || [ -z "$TOKEN" ] || [ "$TOKEN" == "null" ]; then
            echo "âŒ ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ token"
            echo "Python exit code: $PYTHON_EXIT"
            echo "Python output: $TOKEN"
            echo "Response body: $BODY"
            exit 1
          fi
          
          echo "âœ… Token Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾"
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Check products folder exists
        run: |
          if [ ! -d "${{ env.PRODUCTS_PATH }}" ]; then
            echo "âŒ ÐŸÐ°Ð¿ÐºÐ° '${{ env.PRODUCTS_PATH }}' Ð½Ðµ Ñ–ÑÐ½ÑƒÑ”"
            exit 1
          fi
          
          PRODUCT_COUNT=$(find "${{ env.PRODUCTS_PATH }}" -name "product.json" -type f | wc -l)
          echo "ðŸ“¦ Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ $PRODUCT_COUNT Ñ‚Ð¾Ð²Ð°Ñ€Ñ–Ð² Ð´Ð»Ñ Ñ–Ð¼Ð¿Ð¾Ñ€Ñ‚Ñƒ"
          
          if [ "$PRODUCT_COUNT" -eq 0 ]; then
            echo "âš ï¸  ÐÐµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ñ–Ð² Ð´Ð»Ñ Ñ–Ð¼Ð¿Ð¾Ñ€Ñ‚Ñƒ"
            exit 0
          fi

      - name: Run bulk import script
        env:
          ADMIN_TOKEN: ${{ steps.get_token.outputs.token }}
          API_BASE_URL: ${{ env.API_BASE_URL }}
        run: |
          echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº bulk import..."
          python scripts/bulk_import_products.py \
            --path "${{ env.PRODUCTS_PATH }}" \
            --api-url "${{ env.API_BASE_URL }}" \
            --token "$ADMIN_TOKEN" || {
            if [ "${{ inputs.skip_errors }}" == "true" ]; then
              echo "âš ï¸  ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ¸ Ñ–Ð³Ð½Ð¾Ñ€Ð¾Ð²Ð°Ð½Ñ– (skip_errors=true)"
              exit 0
            else
              echo "âŒ Bulk import Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð²ÑÑ Ð· Ð¿Ð¾Ð¼Ð¸Ð»ÐºÐ°Ð¼Ð¸"
              exit 1
            fi
          }

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Bulk Import Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Products Path**: \`${{ env.PRODUCTS_PATH }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL**: \`${{ env.API_BASE_URL }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Bulk import Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!" >> $GITHUB_STEP_SUMMARY

